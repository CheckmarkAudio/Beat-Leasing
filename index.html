<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkmark Beat Leasing</title>
  <style>
    body { font-family: Arial, sans-serif; background: #fff; color: #000; margin: 0; padding: 20px; }
    .container { max-width: 480px; margin: 20px auto; border: 1px solid #000; padding: 20px; border-radius: 8px; }
    h1, h2, h3 { margin-top: 0; text-align: center; }
    .instructions { background: #eef; padding: 10px; border: 1px solid #99c; border-radius: 4px; margin: 15px 0; }
    label { display: block; margin: 10px 0 5px; }
    input, button, textarea, select { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #000; border-radius: 4px; box-sizing: border-box; }
    .tiers { margin: 20px 0; }
    .tier { margin-bottom: 15px; border: 1px solid #000; padding: 10px; border-radius: 6px; }
    .download-btn { display: none; background: #000; color: #fff; padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; margin-top: 8px; }
    #notification { background: #fdd; padding: 10px; margin-bottom: 20px; border: 1px solid #f00; display: none; }
    #adminPanel { margin-top: 20px; border-top: 1px dashed #000; padding-top: 10px; display: none; }
    #agreementSection, #pricingSection { display: none; margin-top: 10px; }
    ul { list-style: none; padding: 0; max-height: 200px; overflow-y: auto; }
    li { margin-bottom: 8px; border-bottom: 1px solid #ccc; padding-bottom: 4px; }
    .mark-btn { background: #000; color: #fff; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; }
    .flex-row { display: flex; gap: 8px; align-items: center; }
    .flex-row button { flex: 1; }
  </style>
  <!-- Firebase Compat SDKs for global namespace support -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>
  <div class="container" id="setup">
    <img src="https://static.wixstatic.com/media/afbb39_617140a20fbb47b2b858c0d3ef28a4ef~mv2.png" alt="Logo" style="max-width:120px; display:block; margin:0 auto 10px;" />
    <h1>Checkmark Beat Leasing Setup</h1>
    <label>Banner URL:<input type="url" id="bannerURL" placeholder="https://..." /></label>
    <label>Producer Name:<input type="text" id="producerName" placeholder="Checkmark Audio" /></label>
    <button id="saveSetup">Save & Launch Widget</button>
  </div>

  <div class="container" id="widget" style="display:none;">
    <div id="notification"></div>
    <img id="bannerImg" alt="Banner" style="width:100%; margin-bottom:10px; display:block;" />
    <h2 id="brandName"></h2>
    <div class="instructions">To purchase a beat, select your lease tier, enter the Beat Title/ID and your contact email, then click "Submit Order."</div>
    <div class="tiers" id="tiersContainer"></div>
    <label>Beat Title:<input type="text" id="beatTitle" /></label>
    <label>Email:<input type="email" id="emailInput" /></label>
    <button id="continueBtn">Submit Order</button>
    <div id="adminPanel">
      <h3>Admin Panel</h3>
      <div class="flex-row">
        <button id="viewPendingBtn">Pending Orders</button>
        <button id="viewCompletedBtn">Completed Orders</button>
      </div>
      <ul id="pendingOrders" style="display:none;"></ul>
      <ul id="completedOrders" style="display:none;"></ul>
      <button id="toggleAgreementBtn">Toggle Lease Editor</button>
      <div id="agreementSection">
        <div class="flex-row" style="margin-bottom:10px;">
          <label for="editTierSelect" style="margin:0; flex-shrink:0;">Select Tier:</label>
          <select id="editTierSelect" style="flex:1;"></select>
          <button id="saveAgreementBtn" style="flex-shrink:0;">Save Agreement</button>
        </div>
        <textarea id="agreementEditor" rows="12"></textarea>
      </div>
      <button id="togglePricingBtn">Toggle Pricing Editor</button>
      <div id="pricingSection">
        <div id="pricingContainer"></div>
        <button id="savePricingBtn">Save Pricing</button>
      </div>
      <h3>Banner & Password</h3>
      <label>Banner URL:<input type="url" id="bannerAdminURL" /></label>
      <button id="saveBannerBtn">Save Banner</button>
      <label>New Admin Password:<input type="text" id="newAdminPassword" /></label>
      <button id="saveAdmin">Save Password</button>
      <button id="resetBtn" style="margin-top:20px;">Reset All Data</button>
    </div>
  </div>

  <script>
    // Initialize Firebase
    firebase.initializeApp({
      apiKey: "AIzaSyCarCLcVjERgmn0hOAoh3iN3poOIo9Zxsg",
      authDomain: "beat-leasing.firebaseapp.com",
      projectId: "beat-leasing",
      storageBucket: "beat-leasing.appspot.com",
      messagingSenderId: "881274422822",
      appId: "1:881274422822:web:3d3913844fd839962048e7",
      measurementId: "G-GY4Y2HWY4J"
    });
    const auth = firebase.auth();
    const db = firebase.firestore();

    const defaultConfig = {
      banner: '',
      producerName: '',
      adminPassword: 'Checkmark Audio',
      tiers: [
        {id:'mp3',name:'MP3 Lease',usage:'Up to 10,000 streams…',price:'$30'},
        {id:'wav',name:'WAV Lease',usage:'Up to 50,000 streams…',price:'$60'},
        {id:'unlimited',name:'Unlimited Lease',usage:'Unlimited streams…',price:'$150'},
        {id:'exclusive',name:'Exclusive Rights',usage:'Sole license…',price:'$800'}
      ],
      agreements: {
        mp3: `MP3 Lease Agreement\n\n1. Grant…`,
        wav: `WAV Lease Agreement\n\n1. Grant…`,
        unlimited: `Unlimited Lease Agreement\n\n1. Grant…`,
        exclusive: `Exclusive Rights Agreement\n\n1. Grant…`
      }
    };

    let cfg, uid, docRef;
    const setupDiv = document.getElementById('setup');
    const widgetDiv = document.getElementById('widget');
    function showSetup() { setupDiv.style.display = 'block'; widgetDiv.style.display = 'none'; }
    function showWidget() { setupDiv.style.display = 'none'; widgetDiv.style.display = 'block'; }

    // Orders handling
    async function loadOrders() {
      const snap = await db.collection('configs').doc(uid).collection('orders').get();
      return snap.docs.map(d => ({id:d.id, ...d.data()}));
    }
    async function saveOrder(order) {
      await db.collection('configs').doc(uid).collection('orders').add(order);
    }
    async function markComplete(id) {
      await db.collection('configs').doc(uid).collection('orders').doc(id).update({completed:true});
    }

    async function renderNotification() {
      const orders = await loadOrders();
      const pendingCount = orders.filter(o => !o.completed).length;
      const notif = document.getElementById('notification');
      if (pendingCount) {
        notif.textContent = `You have ${pendingCount} pending orders`;
        notif.style.display = 'block';
      } else {
        notif.style.display = 'none';
      }
    }

    async function renderOrders() {
      const orders = await loadOrders();
      const pendingList = document.getElementById('pendingOrders');
      const completedList = document.getElementById('completedOrders');
      pendingList.innerHTML = ''; completedList.innerHTML = '';
      orders.forEach(o => {
        const li = document.createElement('li');
        li.textContent = `${new Date(o.date).toLocaleString()} | ${o.beat} | ${o.tier} | ${o.email}`;
        if (!o.completed) {
          const btn = document.createElement('button');
          btn.textContent = 'Mark Complete'; btn.className = 'mark-btn';
          btn.onclick = () => markComplete(o.id).then(renderOrders).then(renderNotification);
          li.appendChild(btn);
          pendingList.appendChild(li);
        } else {
          completedList.appendChild(li);
        }
      });
    }

    function generatePDF(id) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF(); let y = 20;
      doc.setFontSize(16); doc.text(cfg.tiers.find(t => t.id===id).name + ' Agreement', 20, y); y += 10;
      doc.setFontSize(11);
      const text = cfg.agreements[id].replace(/{{producer}}/g, cfg.producerName);
      const lines = doc.splitTextToSize(text, 170);
      lines.forEach(line => { if(y>280){doc.addPage(); y=20;} doc.text(line,20,y); y+=7; });
      doc.save(`${id}-agreement.pdf`);
    }

    function populateTiers() {
      const container = document.getElementById('tiersContainer'); container.innerHTML='';
      cfg.tiers.forEach(t => {
        const div = document.createElement('div'); div.className='tier';
        div.innerHTML = `
          <label><input type="radio" name="tier" value="${t.id}"/> <strong>${t.name}</strong></label>
          <div>${t.usage}</div>
          <div>Price: <strong>${t.price}</strong></div>
          <button class="download-btn" data-tier="${t.id}">Download Agreement</button>
        `;
        container.appendChild(div);
      });
      document.querySelectorAll('input[name="tier"]').forEach(r => r.onchange = () => {
        document.querySelectorAll('.download-btn').forEach(b=>b.style.display='none');
        const btn = document.querySelector(`.download-btn[data-tier="${r.value}"]`);
        if(btn) btn.style.display='block';
      });
      document.querySelectorAll('.download-btn').forEach(b => b.onclick = () => generatePDF(b.dataset.tier));
    }

    function populateAgreementEditor() {
      const sel = document.getElementById('editTierSelect'); sel.innerHTML='';
      cfg.tiers.forEach(t => { const o=document.createElement('option'); o.value=t.id; o.textContent=t.name; sel.appendChild(o); });
      sel.onchange = () => document.getElementById('agreementEditor').value = cfg.agreements[sel.value];
      sel.dispatchEvent(new Event('change'));
    }

    function populatePricingEditor() {
      const pc = document.getElementById('pricingContainer'); pc.innerHTML='';
      cfg.tiers.forEach(t => {
        const div=document.createElement('div');
        div.innerHTML = `<label>${t.name} Price:<input type="text" id="price_${t.id}" value="${t.price}"/></label>`;
        pc.appendChild(div);
      });
    }

    function initWidget() {
      document.getElementById('bannerImg').src=cfg.banner;
      document.getElementById('brandName').textContent=cfg.producerName;
      populateTiers(); renderNotification();

      document.getElementById('continueBtn').onclick = async () => {
        const beat = document.getElementById('beatTitle').value.trim(),
              email = document.getElementById('emailInput').value.trim(),
              sel = document.querySelector('input[name="tier"]:checked');
        if(!beat||!email||!sel) return alert('Select tier, enter beat and email.');
        if(email === cfg.adminPassword) {
          document.getElementById('adminPanel').style.display='block';
          renderOrders(); populateAgreementEditor(); populatePricingEditor();
          document.getElementById('bannerAdminURL').value=cfg.banner;
          return;
        }
        await saveOrder({date:new Date().toISOString(),beat,tier:sel.value,email,completed:false});
        alert('Order received!');
        document.getElementById('beatTitle').value='';document.getElementById('emailInput').value='';
        document.querySelectorAll('input[name="tier"]').forEach(r=>r.checked=false);
        document.querySelectorAll('.download-btn').forEach(b=>b.style.display='none');
        renderNotification();
      };

      ['viewPendingBtn','viewCompletedBtn','toggleAgreementBtn','togglePricingBtn'].forEach(id => {
        document.getElementById(id).onclick = () => toggle(id==='viewPendingBtn'? 'pendingOrders' : id==='viewCompletedBtn'? 'completedOrders' : id==='toggleAgreementBtn'? 'agreementSection' : 'pricingSection');
      });

      document.getElementById('saveAgreementBtn').onclick = async () => {
        const id = document.getElementById('editTierSelect').value;
        cfg.agreements[id] = document.getElementById('agreementEditor').value;
        await docRef.set(cfg);
        alert('Agreement updated.');
      };

      document.getElementById('savePricingBtn').onclick = async () => {
        cfg.tiers.forEach(t=>t.price=document.getElementById(`price_${t.id}`).value);
        await docRef.set(cfg);
        alert('Pricing updated.'); populateTiers();
      };

      document.getElementById('saveBannerBtn').onclick = async () => {
        cfg.banner = document.getElementById('bannerAdminURL').value.trim();
        document.getElementById('bannerImg').src=cfg.banner;
        await docRef.set(cfg);
        alert('Banner updated.');
      };

      document.getElementById('saveAdmin').onclick = async () => {
        const np=document.getElementById('newAdminPassword').value.trim();
        if(!np) return;
        cfg.adminPassword=np; await docRef.set(cfg);
        alert('Password updated.'); document.getElementById('newAdminPassword').value='';
      };

      document.getElementById('resetBtn').onclick = async () => {
        const pw = prompt('Enter admin password to reset:');
        if(pw===cfg.adminPassword){ await docRef.delete(); location.reload(); }
        else alert('Incorrect password.');
      };
    }

    function toggle(id) { const e = document.getElementById(id); e.style.display = e.style.display==='block'?'none':'block'; }

    document.addEventListener('DOMContentLoaded', async () => {
      await auth.signInAnonymously().catch(console.error);
      auth.onAuthStateChanged(async user => {
        if(!user) return;
        uid=user.uid; docRef=db.collection('configs').doc(uid);
        const snap=await docRef.get();
        if(snap.exists && snap.data().producerName){ cfg=snap.data(); initWidget(); showWidget(); }
        else showSetup();
      });
      document.getElementById('saveSetup').onclick = async () => {
        if(!auth.currentUser) await auth.signInAnonymously();
        uid=auth.currentUser.uid; docRef=db.collection('configs').doc(uid);
        const snap=await docRef.get(); cfg=snap.exists? snap.data(): defaultConfig;
        cfg.agreements={...defaultConfig.agreements, ...cfg.agreements};
        cfg.banner=document.getElementById('bannerURL').value.trim();
        cfg.producerName=document.getElementById('producerName').value.trim()|| defaultConfig.producerName;
        await docRef.set(cfg); initWidget(); showWidget();
      };
    });
  </script>
</body>
</html>
