<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkmark Lease Maker</title>
  <style>
    body { font-family: Arial, sans-serif; background: #fff; color: #000; margin: 0; padding: 20px; }
    .container { max-width: 480px; margin: 20px auto; border: 1px solid #000; padding: 20px; border-radius: 8px; }
    h1, h2, h3 { margin-top: 0; text-align: center; }
    .instructions { background: #eef; padding: 10px; border: 1px solid #99c; border-radius: 4px; margin: 15px 0; }
    label { display: block; margin: 10px 0 5px; }
    input, button, textarea, select { width: 100%; padding: 8px; margin-bottom: 10px; border: 1px solid #000; border-radius: 4px; box-sizing: border-box; }
    .tiers { margin: 20px 0; }
    .tier { margin-bottom: 15px; border: 1px solid #000; padding: 10px; border-radius: 6px; }
    .download-btn { display: none; background: #000; color: #fff; padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; margin-top: 8px; }
    #notification { background: #fdd; padding: 10px; margin-bottom: 20px; border: 1px solid #f00; display: none; }
    #adminPanel { margin-top: 20px; border-top: 1px dashed #000; padding-top: 10px; display: none; }
    #agreementSection, #pricingSection { display: none; margin-top: 10px; }
    ul { list-style: none; padding: 0; }
    li { margin-bottom: 8px; border-bottom: 1px solid #ccc; padding-bottom: 4px; }
    .mark-btn { background: #000; color: #fff; padding: 4px 8px; border: none; border-radius: 4px; cursor: pointer; }
    .flex-row { display: flex; gap: 8px; align-items: center; }
    .flex-row button { flex: 1; }
  </style>
  <!-- jsPDF for PDF generation -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- 1) Load Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js"></script>
  <!-- 2) Initialize Firebase -->
  <script>
    firebase.initializeApp({
      apiKey: "AIzaSyCarCLcVjERgmn0hOAoh3iN3poOIo9Zxsg",
      authDomain: "beat-leasing.firebaseapp.com",
      projectId: "beat-leasing",
      storageBucket: "beat-leasing.firebasestorage.app",
      messagingSenderId: "881274422822",
      appId: "1:881274422822:web:3d3913844fd839962048e7",
      measurementId: "G-GY4Y2HWY4J"
    });
    const auth = firebase.auth();
    const db   = firebase.firestore();
    auth.signInAnonymously().catch(console.error);
  </script>
</head>
<body>
  <!-- Setup Screen -->
  <div class="container" id="setup">
    <img src="https://static.wixstatic.com/media/afbb39_617140a20fbb47b2b858c0d3ef28a4ef~mv2.png" alt="Logo" style="max-width:120px; display:block; margin:0 auto 10px;" />
    <h1>Checkmark Beat Leasing Setup</h1>
    <label>Banner URL:<input type="url" id="bannerURL" placeholder="https://..." /></label>
    <label>Producer Name:<input type="text" id="producerName" placeholder="Checkmark Audio" /></label>
    <button id="saveSetup">Save & Launch Widget</button>
  </div>

  <!-- Main Widget -->
  <div class="container" id="widget" style="display:none;">
    <div id="notification"></div>
    <img id="bannerImg" alt="Banner" style="width:100%; margin-bottom:10px; display:block;" />
    <h2 id="brandName"></h2>
    <div class="instructions">To purchase a beat, select your lease tier, enter the Beat Title/ID and your contact email, then click "Submit Order." We’ll send payment instructions and deliver the beat upon confirmation.</div>
    <div class="tiers" id="tiersContainer"></div>
    <label>Beat Title:<input type="text" id="beatTitle" /></label>
    <label>Email:<input type="email" id="emailInput" /></label>
    <button id="continueBtn">Submit Order</button>

    <!-- Admin Panel -->
    <div id="adminPanel">
      <h3>Admin Panel</h3>
      <div class="flex-row">
        <button id="viewPendingBtn">Pending Orders</button>
        <button id="viewCompletedBtn">Completed Orders</button>
      </div>
      <ul id="pendingOrders" style="display:none;"></ul>
      <ul id="completedOrders" style="display:none;"></ul>
      <button id="toggleAgreementBtn">Toggle Lease Editor</button>
      <div id="agreementSection">
        <div class="flex-row" style="margin-bottom:10px;">
          <label for="editTierSelect" style="margin:0; flex-shrink:0;">Select Tier:</label>
          <select id="editTierSelect" style="flex:1;"></select>
          <button id="saveAgreementBtn" style="flex-shrink:0;">Save Agreement</button>
        </div>
        <textarea id="agreementEditor" rows="12"></textarea>
      </div>
      <button id="togglePricingBtn">Toggle Pricing Editor</button>
      <div id="pricingSection">
        <div id="pricingContainer"></div>
        <button id="savePricingBtn">Save Pricing</button>
      </div>
      <h3>Banner & Password</h3>
      <label>Banner URL:<input type="url" id="bannerAdminURL" /></label>
      <button id="saveBannerBtn">Save Banner</button>
      <label>New Admin Password:<input type="text" id="newAdminPassword" /></label>
      <button id="saveAdmin">Save Password</button>
      <button id="resetBtn" style="margin-top:20px;">Reset All Data</button>
    </div>
  </div>

  <!-- App Logic -->
  <script>
    const defaultConfig = {
      banner: '',
      producerName: '',
      adminPassword: 'Checkmark Audio',
      tiers: [
        {id:'mp3',      name:'MP3 Lease',      usage:'Up to 10,000 streams…',    price:'$30'},
        {id:'wav',      name:'WAV Lease',      usage:'Up to 50,000 streams…',    price:'$60'},
        {id:'unlimited',name:'Unlimited Lease',usage:'Unlimited streams…',      price:'$150'},
        {id:'exclusive',name:'Exclusive Rights',usage:'Sole license, unlimited…', price:'$800'}
      ],
      agreements: {
        mp3:       `MP3 Lease Agreement\n\n1. Grant…`,
        wav:       `WAV Lease Agreement\n\n1. Grant…`,
        unlimited: `Unlimited Lease Agreement\n\n1. Grant…`,
        exclusive: `Exclusive Rights Agreement\n\n1. Grant…`
      }
    };
    let cfg, uid, docRef;
    const setupDiv  = document.getElementById('setup');
    const widgetDiv = document.getElementById('widget');
    function showSetup(){ setupDiv.style.display='block'; widgetDiv.style.display='none'; }
    function showWidget(){ setupDiv.style.display='none'; widgetDiv.style.display='block'; }

    // Firestore CRUD
    async function loadOrders(){ const snap=await db.collection('configs').doc(uid).collection('orders').get(); return snap.docs.map(d=>({id:d.id,...d.data()})); }
    async function saveOrder(o){ await db.collection('configs').doc(uid).collection('orders').add(o); }
    async function markComplete(id){ await db.collection('configs').doc(uid).collection('orders').doc(id).update({completed:true}); }

    // Rendering and PDF logic … (same as before) …
    function initWidget(){ /* populateTiers, renderNotification, bind event handlers */ }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('saveSetup').onclick = async () => {
        // ensure auth
        if (!auth.currentUser) await auth.signInAnonymously();
        uid = auth.currentUser.uid;
        docRef = db.collection('configs').doc(uid);
        // load or init config
        const snap = await docRef.get();
        cfg = snap.exists ? snap.data() : defaultConfig;
        cfg.agreements = Object.assign({}, defaultConfig.agreements, cfg.agreements);
        // set from inputs
        cfg.banner       = document.getElementById('bannerURL').value.trim();
        cfg.producerName = document.getElementById('producerName').value.trim() || defaultConfig.producerName;
        await docRef.set(cfg);
        initWidget(); showWidget();
      };

      auth.onAuthStateChanged(async user => {
        if (!user) return;
        uid    = user.uid;
        docRef = db.collection('configs').doc(uid);
        const snap = await docRef.get();
        if (snap.exists && snap.data().producerName) {
          cfg = snap.data();
          initWidget(); showWidget();
        } else {
          showSetup();
        }
      });
    });
  </script>
</body>
</html>
